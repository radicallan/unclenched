
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Spirit Board — ULTRA‑SAFE</title>
<style>
  :root{--bg:#0b0d12;--panel:#0f121a;--ink:#e7ebf2;--muted:#96a0b1;--accent:#7ae1ff;--good:#7bf59a;--warn:#ffd166;--bad:#ff6b6b}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid #1b2330;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{appearance:none;border:1px solid #2a3a58;background:#0f1726;color:var(--ink);padding:9px 12px;border-radius:12px;cursor:pointer}
  #status{margin-left:auto;color:#a9b3c6}
  #banner{display:none;padding:8px 12px;background:#3a0d12;color:#ffdddd;border-bottom:1px solid #5a1a22}
  #stage{height:68vh; position:relative}
  #cv{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;-webkit-user-select:none;user-select:none}
  .panel{border-top:1px solid #1b2330;background:#0a0f16;padding:10px}
  .panel h3{margin:0 0 8px 0;font-size:14px;color:#cfe2ff}
  textarea#ta{width:100%;min-height:16vh;max-height:34vh;background:#0b1018;color:#eaf2ff;border:1px solid #2a3a58;border-radius:10px;padding:10px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div id="banner">Render error. Try tapping "Force Draw".</div>
<header>
  <button id="btnStart">Invite</button>
  <button id="btnStop">Goodbye</button>
  <button id="btnReset">Reset</button>
  <button id="btnCenter">Center</button>
  <button id="btnForce">Force Draw</button>
  <span id="status">Idle • 0 chars</span>
</header>

<div id="stage"><canvas id="cv"></canvas></div>

<div class="panel">
  <h3>Transcript</h3>
  <textarea id="ta" readonly>(no text)</textarea>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const banner=$('#banner');
  const statusEl=$('#status');
  const ta=$('#ta');
  const cv=$('#cv'); let ctx=null;
  const DPR=Math.min(2, window.devicePixelRatio||1);
  let W=0,H=0, running=false, message="", lastChars=0;
  const plan={x:0,y:0,r:26,trail:[]};
  const tiles=[];
  const state={ lastError:null };

  function showBanner(err){ state.lastError=err; banner.style.display='block'; banner.textContent='Render error: '+err; }
  function hideBanner(){ banner.style.display='none'; }

  function sizeCanvas(){
    try{
      const rect=cv.getBoundingClientRect();
      const w=Math.max(50, Math.floor(rect.width*DPR));
      const h=Math.max(50, Math.floor(rect.height*DPR));
      if(cv.width!==w) cv.width=w;
      if(cv.height!==h) cv.height=h;
      W=cv.width; H=cv.height;
      plan.r=Math.max(22*DPR, Math.min(W,H)*0.045);
      if(!ctx){ ctx=cv.getContext('2d',{alpha:true}); }
      hideBanner();
      buildTiles();
      if(plan.x===0 && plan.y===0) center();
      draw();
    }catch(e){ showBanner(e.message||String(e)); }
  }

  function center(){ plan.x=W*0.52; plan.y=H*0.60; draw(); }

  window.addEventListener('load', sizeCanvas);
  window.addEventListener('resize', ()=>{ setTimeout(sizeCanvas,100); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(sizeCanvas,300); });
  $('#btnForce').onclick=sizeCanvas;

  // Build a simple layout
  function buildTiles(){
    tiles.length=0;
    const cx=W*0.52, cy=H*0.60, baseR=Math.min(W,H)*0.36;
    const r1=[...'ABCDEFGH'], r2=[...'IJKLMNOP'], r3=[...'QRSTUVWXYZ'], nums=[...'1234567890'];
    const ring=(arr,r)=>{
      const n=arr.length, a0=-Math.PI*0.8, a1=-Math.PI*0.2;
      for(let i=0;i<n;i++){
        const t=i/(n-1), ang=a0+(a1-a0)*t, x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r;
        tiles.push({x,y,r:Math.min(W,H)*0.042,label:arr[i]});
      }
    };
    ring(r1, baseR*0.70); ring(r2, baseR*0.86); ring(r3, baseR*1.02);
    const nbY=cy+baseR*0.55, nr=Math.min(W,H)*0.042;
    for(let i=0;i<nums.length;i++){ const x=(W*0.20)+i*(W*0.6/(nums.length-1)); tiles.push({x,y:nbY,r:nr,label:nums[i]}); }
    tiles.push({x:W*0.18,y:H*0.18,r:Math.min(W,H)*0.055,label:'YES'});
    tiles.push({x:W*0.82,y:H*0.18,r:Math.min(W,H)*0.055,label:'NO'});
    tiles.push({x:W*0.50,y:H*0.18,r:Math.min(W,H)*0.055,label:'GOODBYE'});
  }

  function drawBoard(){
    if(!ctx) return;
    ctx.clearRect(0,0,W,H);
    const g=ctx.createRadialGradient(W*0.62,H*0.35,10, W*0.62,H*0.35, Math.max(W,H)*0.9);
    g.addColorStop(0,'rgba(255,255,255,0.06)'); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
    for(let y=0;y<H;y+=Math.max(24, 26*DPR)){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(W,y+0.5); ctx.stroke(); }
    for(let x=0;x<W;x+=Math.max(24, 26*DPR)){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,H); ctx.stroke(); }

    ctx.strokeStyle='rgba(200,210,230,0.10)'; ctx.lineWidth=Math.max(1, Math.min(W,H)*0.002);
    const cx=W*0.52, cy=H*0.60, baseR=Math.min(W,H)*0.36;
    [0.70,0.86,1.02].forEach(m=>{ ctx.beginPath(); ctx.arc(cx,cy,baseR*m,0,Math.PI*2); ctx.stroke(); });

    ctx.textAlign='center'; ctx.textBaseline='middle';
    const fontBig=(Math.min(W,H)*0.05)+'px ui-monospace,Menlo,Consolas';
    const fontNum=(Math.min(W,H)*0.045)+'px ui-monospace,Menlo,Consolas';
    const fontCor=(Math.min(W,H)*0.04)+'px ui-monospace,Menlo,Consolas';

    for(const t of tiles){
      if(t.label.length===1){ ctx.fillStyle='#cfd6e6'; ctx.font=fontBig; }
      else if(t.label==='YES'){ ctx.fillStyle='#7bf59a'; ctx.font=fontCor; }
      else if(t.label==='NO'){ ctx.fillStyle='#ffb3b3'; ctx.font=fontCor; }
      else { ctx.fillStyle='#9aa3b2'; ctx.font=fontCor; }
      ctx.fillText(t.label, t.x, t.y);
    }
  }

  function drawPlanchette(){
    if(!ctx) return;
    const r=plan.r, x=plan.x, y=plan.y;
    ctx.strokeStyle='rgba(122,225,255,0.25)'; ctx.lineWidth=2;
    ctx.beginPath(); for(let i=0;i<plan.trail.length;i++){ const p=plan.trail[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);} ctx.stroke();
    ctx.fillStyle='rgba(16,24,36,0.92)'; ctx.strokeStyle='rgba(45,90,150,0.85)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.ellipse(x,y,r*1.1,r,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.10)'; ctx.beginPath(); ctx.arc(x,y,r*0.38,0,Math.PI*2); ctx.fill();
  }

  function draw(){ try{ drawBoard(); drawPlanchette(); hideBanner(); }catch(e){ showBanner(e.message||String(e)); } }

  // Simple hit test and commit
  function hit(x,y){ for(const t of tiles){ if(Math.hypot(x-t.x,y-t.y)<=t.r) return t; } return null; }
  function commit(lab){
    if(lab==='GOODBYE'){ message += ' [GOODBYE]'; running=false; }
    else if(lab==='YES' || lab==='NO'){ message += ` [${lab}]`; }
    else if(lab && lab.length===1){ message += lab; }
    updateStatus();
  }

  function updateStatus(){
    const chars = (message.replace(/\s/g,'').length);
    statusEl.textContent = (running?'Listening':'Idle') + ' • ' + chars + ' chars';
    ta.value = message || '(no text)';
    ta.scrollTop = ta.scrollHeight;
  }

  // Movement (touch + mouse)
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function toCanvasCoords(clientX,clientY){
    const r=cv.getBoundingClientRect();
    return { x: (clientX - r.left)*DPR, y: (clientY - r.top)*DPR };
  }

  cv.addEventListener('touchstart', e=>{
    e.preventDefault();
    const t=e.changedTouches[0];
    const p=toCanvasCoords(t.clientX, t.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H);
    draw();
  }, {passive:false});

  cv.addEventListener('touchmove', e=>{
    e.preventDefault();
    const t=e.changedTouches[0];
    const p=toCanvasCoords(t.clientX, t.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H);
    plan.trail.push({x:plan.x,y:plan.y}); if(plan.trail.length>600) plan.trail.shift();
    draw();
  }, {passive:false});

  cv.addEventListener('touchend', e=>{
    e.preventDefault();
    const t=e.changedTouches[0];
    const p=toCanvasCoords(t.clientX, t.clientY);
    const tile = hit(plan.x, plan.y);
    if(tile){ commit(tile.label); }
  }, {passive:false});

  cv.addEventListener('mousedown', e=>{
    const p=toCanvasCoords(e.clientX, e.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H);
    draw();
  });
  cv.addEventListener('mousemove', e=>{
    if(e.buttons!==1) return;
    const p=toCanvasCoords(e.clientX, e.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H);
    plan.trail.push({x:plan.x,y:plan.y}); if(plan.trail.length>600) plan.trail.shift();
    draw();
  });
  cv.addEventListener('mouseup', e=>{
    const tile = hit(plan.x, plan.y);
    if(tile){ commit(tile.label); }
  });

  // Buttons
  $('#btnStart').onclick=()=>{ running=true; message=''; plan.trail.length=0; updateStatus(); };
  $('#btnStop').onclick=()=>{ if(!running) return; commit('GOODBYE'); running=false; };
  $('#btnReset').onclick=()=>{ running=false; message=''; plan.trail.length=0; center(); updateStatus(); draw(); };
  $('#btnCenter').onclick=()=>{ center(); };

  // First paint
  updateStatus();
  // In case the stage reports 0x0 at first, force another sizing shortly after load.
  setTimeout(sizeCanvas, 50);
  setTimeout(sizeCanvas, 250);
  setTimeout(sizeCanvas, 800);
})();
</script>
</body>
</html>
