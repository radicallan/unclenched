<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gantt — Unclenched Project Studio</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #f7f6f4;
    --ink: #161616;
    --muted:#6b6b6b;
    --line:#e7e1d8;
    --panel:#ffffff;
    --accent:#8ea2a6;
    --accent-ink:#0a0b0c;
    --good:#3fb077;
    --warn:#caa64a;
    --bad:#ca5a5a;

    --radius:16px;
    --shadow: 0 2px 6px rgba(0,0,0,.06), 0 12px 24px rgba(0,0,0,.06);
    --tap: 44px;

    --row-h: 40px;
    --bar-h: 14px;
    --bar-radius: 10px;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0f1012;
      --ink: #f2f2f2;
      --muted:#a1a1a8;
      --line:#23262b;
      --panel:#14161a;
      --accent:#99a6b6;
      --accent-ink:#0b0d10;
      --shadow: 0 1px 0 rgba(255,255,255,.04), 0 12px 34px rgba(0,0,0,.5);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1200px 800px at 120% 0%, color-mix(in srgb, var(--accent) 10%, transparent), transparent),
      radial-gradient(1200px 900px at -20% 120%, color-mix(in srgb, var(--accent) 10%, transparent), transparent),
      var(--bg);
    color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-text-size-adjust:100%;
  }
  header{
    position:sticky;top:0;z-index:40;
    backdrop-filter:saturate(115%) blur(8px);
    background: color-mix(in srgb, var(--bg) 92%, white);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1400px;margin:0 auto;padding:0 14px}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border:1px solid var(--ink);border-radius:10px;display:grid;place-items:center;font-weight:800}
  .btn{
    display:inline-flex;align-items:center;gap:8px;justify-content:center;
    min-height:var(--tap); padding:6px 12px;
    border:1px solid var(--ink);border-radius:12px;background:var(--panel);
    box-shadow:var(--shadow); cursor:pointer; user-select:none;
    font-weight:600
  }
  .btn.secondary{border-color:var(--line);color:var(--muted)}
  .btn.ghost{background:transparent;border-color:var(--line)}
  .btn.warn{border-color:var(--warn);color:var(--warn)}
  .btn.good{border-color:var(--good);color:var(--good)}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{border:0;background:transparent;padding:10px 12px;min-height:var(--tap);cursor:pointer}
  .seg button.active{background:var(--panel);border-right:1px solid var(--line)}
  .seg button+button{border-left:1px solid var(--line)}
  .search{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:0 12px;min-height:var(--tap)}
  .search input{border:0;outline:0;background:transparent;color:inherit;min-width:120px}
  main{display:grid;grid-template-columns:320px 1fr;gap:14px;max-width:1400px;margin:14px auto;padding:0 14px}
  @media (max-width:1000px){ main{grid-template-columns:1fr} }
  .panel{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .left{overflow:auto;max-height:calc(100dvh - 160px)}
  .left header{position:sticky;top:0;background:var(--panel);padding:10px;border-bottom:1px solid var(--line)}
  .tasklist{padding:10px}
  .task{display:grid;grid-template-columns: 1fr 80px 80px 60px;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:8px 2px}
  .task input[type="text"]{border:1px solid var(--line);border-radius:10px;padding:8px;background:transparent}
  .pill{display:inline-flex;align-items:center;justify-content:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
  .right{position:relative;overflow:hidden}
  .r-head{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line)}
  .chart-wrap{position:relative;overflow:auto;max-height:calc(100dvh - 160px)}
  .layers{position:relative;min-width:900px}
  .grid-bg{position:absolute;inset:0;background:
      repeating-linear-gradient(to bottom, transparent, transparent var(--row-h), color-mix(in srgb, var(--ink) 6%, transparent) var(--row-h), color-mix(in srgb, var(--ink) 6%, transparent) calc(var(--row-h) + 1px));
  }
  svg{display:block}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .legend .dot{width:10px;height:10px;border-radius:50%}
  .hint{color:var(--muted);font-size:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:color-mix(in srgb, var(--ink) 6%, transparent);border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .range{appearance:none; height:6px; border-radius:5px; background:linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent) 30%, transparent)); outline:none}
  .range::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;border:1px solid var(--ink);background:var(--panel);box-shadow:var(--shadow);cursor:pointer}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:20px;z-index:99
  }
  .modal.open{display:flex}
  .sheet{max-width:900px;width:100%;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  textarea{width:100%;min-height:300px;border:1px solid var(--line);border-radius:12px;background:transparent;padding:10px;color:inherit}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1}
  .badge{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="brand">
        <div class="logo">U</div>
        <div>
          <div style="font-weight:800;letter-spacing:.02em">Unclenched Gantt</div>
          <div class="badge">Fancy, innovative, and fast — no libraries</div>
        </div>
      </div>
      <div class="tools">
        <div class="seg" aria-label="Zoom">
          <button id="zoomOut" title="Zoom out ( - )">–</button>
          <button id="zoomReset" class="active" title="Reset zoom ( 0 )">100%</button>
          <button id="zoomIn" title="Zoom in ( + )">+</button>
        </div>
        <button class="btn" id="addTask">＋ Task</button>
        <button class="btn secondary" id="toggleCritical">Critical Path</button>
        <button class="btn" id="exportPNG" title="Export chart as PNG">Export PNG</button>
        <button class="btn" id="exportCSV" title="Export tasks as CSV">Export CSV</button>
        <button class="btn" id="importJSON">Import / Export JSON</button>
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3m1.3-5.2A7 7 0 1 1 7 4a7 7 0 0 1 11 7.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="search" placeholder="Search tasks…" />
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: Task table -->
    <section class="panel left" aria-label="Task list">
      <header>
        <div class="row">
          <strong>Tasks</strong>
          <span class="spacer"></span>
          <span class="hint">Double-click a date to edit. Drag bars on the chart to move/resize. </span>
        </div>
      </header>
      <div class="tasklist" id="taskList"></div>
    </section>

    <!-- RIGHT: Chart -->
    <section class="panel right" aria-label="Gantt chart">
      <div class="r-head">
        <div class="legend">
          <div class="dot" style="background:var(--good)"></div><span class="hint">On track</span>
          <div class="dot" style="background:var(--warn)"></div><span class="hint">At risk</span>
          <div class="dot" style="background:var(--bad)"></div><span class="hint">Blocked</span>
          <span class="hint">| Today line • <span class="kbd">←→</span> pan • <span class="kbd">+</span>/<span class="kbd">-</span> zoom</span>
        </div>
        <div class="status">
          <label class="hint">Zoom</label>
          <input type="range" id="zoomRange" class="range" min="40" max="160" value="80" />
        </div>
      </div>

      <div class="chart-wrap" id="chartWrap">
        <div class="layers">
          <div class="grid-bg" id="gridBg"></div>
          <svg id="chart" width="2000" height="800" aria-label="Timeline"></svg>
        </div>
      </div>
    </section>
  </main>

  <!-- JSON Modal -->
  <div class="modal" id="jsonModal" aria-hidden="true" role="dialog" aria-label="Import / Export JSON">
    <div class="sheet">
      <div class="row">
        <strong>Task Data (JSON)</strong>
        <span class="spacer"></span>
        <button class="btn ghost" id="closeJSON">Close</button>
      </div>
      <p class="hint" style="margin:6px 0 10px">Paste JSON to import or copy out to export. Autosaves to your browser.</p>
      <textarea id="jsonArea"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn good" id="applyJSON">Apply JSON</button>
        <button class="btn" id="downloadJSON">Download .json</button>
        <span class="spacer"></span>
        <button class="btn warn" id="resetDemo">Reset to Demo</button>
      </div>
    </div>
  </div>

<script>
/* -----------------------------------------------------------
   UNCLENCHED GANTT — single-file, no libraries
   Features: zoom, pan, drag, resize, dependencies, critical path,
             today line, CSV/PNG export, JSON import/export,
             autosave to localStorage, search filter
   ----------------------------------------------------------- */

const dayMS = 24*60*60*1000;
let dayWidth = 80;               // px per day (zoomable)
let rowHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h')) || 40;
let barHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bar-h')) || 14;

const state = {
  tasks: [],
  links: [],                     // {from, to}
  viewport: {start: null, end: null},
  dragging: null,                // {id, type: 'move'|'resizeL'|'resizeR', startX, orig}
  critical: false,
  filter: ""
};

// --- Demo data
const demo = {
  tasks: [
    {id:'D1', name:'Discovery', start:addDays(today(), -3), end:addDays(today(), 4), status:'good', progress:60, assignee:'Allan', group:'Phase 1', deps:[]},
    {id:'D2', name:'Stakeholder map', start:addDays(today(), 0), end:addDays(today(), 2), status:'warn', progress:20, assignee:'Jess', group:'Phase 1', deps:['D1']},
    {id:'S1', name:'Schema & validation rules', start:addDays(today(), 3), end:addDays(today(), 9), status:'good', progress:0, assignee:'Lynne', group:'Phase 2', deps:['D2']},
    {id:'S2', name:'Mobile capture PWA', start:addDays(today(), 5), end:addDays(today(), 12), status:'good', progress:0, assignee:'Paul', group:'Phase 2', deps:['D2']},
    {id:'S3', name:'Power BI connector', start:addDays(today(), 10), end:addDays(today(), 14), status:'warn', progress:0, assignee:'Orla', group:'Phase 2', deps:['S1']},
    {id:'R1', name:'Pilot & feedback', start:addDays(today(), 14), end:addDays(today(), 20), status:'good', progress:0, assignee:'Team', group:'Phase 3', deps:['S2','S3']},
    {id:'M1', name:'Go/No-Go', start:addDays(today(), 21), end:addDays(today(), 21), status:'bad', progress:0, assignee:'Board', group:'Milestone', deps:['R1']}
  ]
};

// --- Utilities
function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function addDays(d, n){ return new Date(d.getTime()+n*dayMS); }
function fmt(d){ return new Date(d).toISOString().slice(0,10); }
function parse(d){ return new Date(d+'T00:00:00'); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function uid(){ return Math.random().toString(36).slice(2,8); }

// --- Storage
const LS_KEY = 'unclenched_gantt_v1';
function loadState(){
  const saved = localStorage.getItem(LS_KEY);
  if(saved){
    try{ const obj = JSON.parse(saved); state.tasks = obj.tasks.map(t=>({...t, start:new Date(t.start), end:new Date(t.end)})); return; }catch{}
  }
  state.tasks = demo.tasks;
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify({tasks: state.tasks}));
}

// --- Derived
function calcBounds(){
  const min = new Date(Math.min(...state.tasks.map(t=>t.start)));
  const max = new Date(Math.max(...state.tasks.map(t=>t.end)));
  min.setDate(min.getDate()-5); max.setDate(max.getDate()+5);
  state.viewport.start = min; state.viewport.end = max;
}

// --- DOM refs
const chart = document.getElementById('chart');
const chartWrap = document.getElementById('chartWrap');
const gridBg = document.getElementById('gridBg');
const taskList = document.getElementById('taskList');

loadState(); calcBounds(); renderAll();

// ============================================================
// RENDERING
// ============================================================
function renderAll(){
  renderTaskList();
  renderChart();
  saveState();
}

function renderTaskList(){
  const q = state.filter.toLowerCase();
  taskList.innerHTML = '';
  const header = document.createElement('div');
  header.className='task';
  header.style.fontWeight='700';
  header.innerHTML = `<div>Task</div><div>Start</div><div>End</div><div>%</div>`;
  taskList.append(header);

  state.tasks
    .filter(t => t.name.toLowerCase().includes(q) || t.id.toLowerCase().includes(q) || (t.assignee||'').toLowerCase().includes(q))
    .sort((a,b)=> a.start-b.start || a.name.localeCompare(b.name))
    .forEach(t=>{
      const row = document.createElement('div');
      row.className='task';
      row.dataset.id = t.id;
      row.innerHTML = `
        <input type="text" value="${t.name}" aria-label="Task name">
        <input type="text" value="${fmt(t.start)}" aria-label="Start date" />
        <input type="text" value="${fmt(t.end)}" aria-label="End date" />
        <input type="text" value="${t.progress||0}" aria-label="Progress percent" />
      `;
      // events
      const [nameEl, startEl, endEl, progEl] = row.querySelectorAll('input');
      nameEl.addEventListener('change', e=>{ t.name = e.target.value; renderAll(); });
      [startEl, endEl].forEach((el,ix)=>{
        el.addEventListener('dblclick', ()=> el.select());
        el.addEventListener('change', ()=>{
          const d = parse(el.value);
          if(isNaN(d)) { el.value = fmt(ix? t.end : t.start); return; }
          if(ix===0){ t.start=d; if(t.end<t.start) t.end=t.start; }
          else{ t.end=d; if(t.end<t.start) t.start=t.end; }
          calcBounds(); renderAll();
        });
      });
      progEl.addEventListener('change', e=>{ let v=parseInt(e.target.value)||0; t.progress=clamp(v,0,100); renderAll(); });
      taskList.append(row);
    });
}

function dateToX(date){ return Math.round((date - state.viewport.start)/dayMS*dayWidth)+0.5; }
function xToDate(x){ const d = new Date(state.viewport.start.getTime() + Math.round(x/dayWidth)*dayMS); d.setHours(0,0,0,0); return d; }

function renderChart(){
  // size
  const rows = state.tasks.length;
  const width = Math.ceil((state.viewport.end - state.viewport.start)/dayMS * dayWidth + 200);
  const height = Math.max(rows*rowHeight+60, 320);

  chart.setAttribute('width', width);
  chart.setAttribute('height', height);

  // clear
  chart.innerHTML = '';

  // backgrounds: day grid + week ticks
  const gBg = chart.appendChild(el('g',{class:'grid'}));
  for(let d=new Date(state.viewport.start); d<=state.viewport.end; d=addDays(d,1)){
    const x = dateToX(d);
    const isMon = d.getDay()===1;
    const isSun = d.getDay()===0;
    const line = el('line',{
      x1:x, y1:40, x2:x, y2:height-10,
      stroke: isMon ? 'rgba(100,100,100,.35)' : 'rgba(120,120,120,.15)',
      'stroke-width': isMon?1.25:1
    });
    gBg.appendChild(line);
    if(isMon){
      const label = el('text',{x:x+4, y:30, 'font-size':'12', fill:'var(--muted)'}, fmt(d));
      gBg.appendChild(label);
    }
    if(isSun){
      const rect = el('rect',{x:x, y:40, width:dayWidth, height:height-50, fill:'rgba(125,55,55,.04)'});
      gBg.appendChild(rect);
    }
  }

  // Today line
  const t = today(), tx = dateToX(t);
  chart.appendChild(el('line',{x1:tx, y1:20, x2:tx, y2:height-10, stroke:'var(--bad)', 'stroke-dasharray':'4 4', 'stroke-width':1.5}));
  chart.appendChild(el('text',{x:tx+6, y:16, 'font-size':'12', fill:'var(--bad)'}, 'Today'));

  // rows
  const gRows = chart.appendChild(el('g'));
  state.tasks.forEach((task, i)=>{
    const y = 50 + i*rowHeight;

    // swimlane
    const lane = el('rect',{x:0,y:y- rowHeight + (rowHeight - 24)/2, width:width, height:24, fill:'rgba(0,0,0,.03)'});
    if(i%2===1) gRows.appendChild(lane);

    // text label (sticky-ish look)
    const label = el('text',{x:10, y:y, 'font-size':'12', fill:'var(--muted)'}, `${task.id} — ${task.assignee||''}`);
    gRows.appendChild(label);
  });

  // dependencies first so bars overlay
  const gLinks = chart.appendChild(el('g',{class:'links'}));
  state.tasks.forEach((t)=>{
    (t.deps||[]).forEach(dep=>{
      const A = state.tasks.find(x=>x.id===dep); if(!A) return;
      drawLink(gLinks, A, t);
    });
  });

  // bars
  const gBars = chart.appendChild(el('g',{class:'bars'}));
  state.tasks.forEach((t, i)=>{
    const y = 50 + i*rowHeight;
    const x = dateToX(t.start);
    const w = Math.max( Math.max(1, ((t.end - t.start)/dayMS))*dayWidth , 6);

    const color = t.status==='bad'?'var(--bad)': t.status==='warn'?'var(--warn)':'var(--good)';

    // milestone (start==end)
    const isMilestone = t.start.getTime()===t.end.getTime();

    if(isMilestone){
      const m = el('polygon',{points:`${x},${y-2} ${x+10},${y-10} ${x+20},${y-2} ${x+10},${y+6}`,
         fill:color, stroke:'var(--ink)', 'stroke-width':'1'
      });
      m.dataset.id=t.id;
      m.style.cursor='grab';
      attachDrag(m, t, 'move');
      gBars.appendChild(m);
      const name = el('text',{x:x+28, y:y+3, 'font-size':'13', fill:'var(--ink)'}, t.name);
      gBars.appendChild(name);
      return;
    }

    // bar container
    const bar = el('rect',{x, y:y - barHeight/2, rx:8, ry:8, width:w, height:barHeight, fill:color, stroke:'var(--ink)','stroke-width':1, opacity: .95});
    bar.dataset.id=t.id;
    bar.style.cursor='grab';
    gBars.appendChild(bar);

    // progress overlay
    if((t.progress||0)>0){
      const pw = Math.max(0, Math.min(100, t.progress))/100 * w;
      const prog = el('rect',{x, y:y - barHeight/2, rx:8, ry:8, width:pw, height:barHeight, fill:'rgba(255,255,255,.35)', stroke:'none'});
      gBars.appendChild(prog);
    }

    // handles
    const lh = el('rect',{x:x-5, y:y - barHeight/2 - 4, width:10, height:barHeight+8, fill:'transparent', cursor:'ew-resize'});
    const rh = el('rect',{x:x+w-5, y:y - barHeight/2 - 4, width:10, height:barHeight+8, fill:'transparent', cursor:'ew-resize'});
    gBars.appendChild(lh); gBars.appendChild(rh);

    // name
    const name = el('text',{x:x+6, y:y-8, 'font-size':'12', fill:'var(--ink)'}, t.name);
    gBars.appendChild(name);

    // events
    attachDrag(bar, t, 'move');
    attachDrag(lh, t, 'resizeL');
    attachDrag(rh, t, 'resizeR');

    // tooltip (title)
    bar.appendChild(el('title',{}, `${t.name}\n${fmt(t.start)} → ${fmt(t.end)}\n${t.progress||0}% · ${t.assignee||''}`));
  });

  // critical path
  if(state.critical){ highlightCritical(gBars); }

  // update CSS background rows height
  gridBg.style.height = chart.getAttribute('height')+'px';
  gridBg.style.width  = chart.getAttribute('width')+'px';
}

function el(tag, attrs={}, text){
  const n = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for(const k in attrs) n.setAttribute(k, attrs[k]);
  if(text!=null) n.textContent = text;
  return n;
}

function drawLink(g, fromTask, toTask){
  const i1 = state.tasks.indexOf(fromTask);
  const i2 = state.tasks.indexOf(toTask);
  const y1 = 50 + i1*rowHeight;
  const y2 = 50 + i2*rowHeight;

  const x1 = dateToX(fromTask.end);
  const x2 = dateToX(toTask.start);
  const midX = (x1 + x2)/2;

  const path = `M ${x1} ${y1}
                C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
  const p = el('path',{d:path, fill:'none', stroke:'color-mix(in srgb, var(--ink) 40%, transparent)', 'stroke-width':1.5});
  g.appendChild(p);
  // arrow
  const arr = el('polygon',{points:`${x2},${y2} ${x2-6},${y2-4} ${x2-6},${y2+4}`, fill:'color-mix(in srgb, var(--ink) 40%, transparent)'});
  g.appendChild(arr);
}

// ============================================================
// DRAGGING / RESIZING
// ============================================================
function attachDrag(node, task, type){
  node.addEventListener('pointerdown', (e)=>{
    node.setPointerCapture(e.pointerId);
    state.dragging = {id:task.id, type, startX:e.clientX, orig:{start:new Date(task.start), end:new Date(task.end)}};
  });
}

window.addEventListener('pointermove', (e)=>{
  if(!state.dragging) return;
  const t = state.tasks.find(x=>x.id===state.dragging.id);
  const dx = e.clientX - state.dragging.startX;
  const dayDelta = Math.round(dx/dayWidth);
  if(state.dragging.type==='move'){
    const dur = Math.round((state.dragging.orig.end - state.dragging.orig.start)/dayMS);
    t.start = addDays(state.dragging.orig.start, dayDelta);
    t.end   = addDays(t.start, dur);
  }else if(state.dragging.type==='resizeL'){
    t.start = addDays(state.dragging.orig.start, dayDelta);
    if(t.start>t.end) t.start=t.end;
  }else if(state.dragging.type==='resizeR'){
    t.end = addDays(state.dragging.orig.end, dayDelta);
    if(t.end<t.start) t.end=t.start;
  }
  calcBounds();
  renderChart();
});

window.addEventListener('pointerup', ()=>{
  if(state.dragging){ state.dragging=null; saveState(); renderTaskList(); }
});

// ============================================================
// CRITICAL PATH (longest path by duration over dependencies)
function highlightCritical(gBars){
  // build adjacency and duration
  const map = new Map(state.tasks.map(t=>[t.id,t]));
  const dur = t => Math.max(1, Math.round((t.end - t.start)/dayMS));
  const memo = new Map();
  const deps = t => (t.deps||[]).map(id=>map.get(id)).filter(Boolean);

  function longest(t){
    if(memo.has(t.id)) return memo.get(t.id);
    const bestDep = deps(t).reduce((m, d)=>{
      const val = longest(d);
      return val>m ? val : m;
    }, 0);
    const val = bestDep + dur(t);
    memo.set(t.id, val);
    return val;
  }
  state.tasks.forEach(longest);
  const maxLen = Math.max(...memo.values());
  // highlight bars with distance contributing to max
  state.tasks.forEach((t, i)=>{
    const y = 50 + i*rowHeight;
    const x = dateToX(t.start);
    const w = Math.max( Math.max(1, ((t.end - t.start)/dayMS))*dayWidth , 6);
    const val = memo.get(t.id);
    if(val){
      const glow = el('rect',{x, y:y - barHeight/2 - 4, rx:12, ry:12, width:w, height:barHeight+8,
        fill:'none', stroke:'var(--accent)', 'stroke-width':2.2, 'stroke-dasharray':'4 3'});
      chart.appendChild(glow);
      if(val===maxLen){
        const star = el('text',{x:x+w+6, y:y+4, 'font-size':'12', fill:'var(--accent)'}, '★ critical');
        chart.appendChild(star);
      }
    }
  });
}

// ============================================================
// UI HANDLERS
// ============================================================
document.getElementById('zoomIn').onclick   = ()=>{ dayWidth = clamp(dayWidth+10, 40, 160); syncZoom(); };
document.getElementById('zoomOut').onclick  = ()=>{ dayWidth = clamp(dayWidth-10, 40, 160); syncZoom(); };
document.getElementById('zoomReset').onclick= ()=>{ dayWidth = 80; syncZoom(); };
document.getElementById('zoomRange').oninput= (e)=>{ dayWidth = parseInt(e.target.value); syncZoom(false); };

function syncZoom(updateSlider=true){
  if(updateSlider){ document.getElementById('zoomRange').value = dayWidth; }
  document.getElementById('zoomReset').textContent = Math.round(dayWidth/80*100)+'%';
  renderChart();
}

document.getElementById('addTask').onclick = ()=>{
  const s = xToDate(dateToX(today()) + dayWidth*2);
  const e = addDays(s, 3);
  state.tasks.push({id:uid().toUpperCase(), name:'New task', start:s, end:e, status:'good', progress:0, assignee:'', group:'', deps:[]});
  calcBounds(); renderAll();
};

document.getElementById('toggleCritical').onclick = (e)=>{
  state.critical = !state.critical;
  e.currentTarget.classList.toggle('secondary', !state.critical);
  renderChart();
};

document.getElementById('search').addEventListener('input', (e)=>{
  state.filter = e.target.value || '';
  renderTaskList();
});

// Pan with arrows
window.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft'){ state.viewport.start = addDays(state.viewport.start, -1); state.viewport.end = addDays(state.viewport.end, -1); renderChart(); }
  if(e.key==='ArrowRight'){ state.viewport.start = addDays(state.viewport.start,  1); state.viewport.end = addDays(state.viewport.end,  1); renderChart(); }
  if(e.key==='+'){ dayWidth = clamp(dayWidth+10, 40, 160); syncZoom(); }
  if(e.key==='-'){ dayWidth = clamp(dayWidth-10, 40, 160); syncZoom(); }
  if(e.key==='0'){ dayWidth = 80; syncZoom(); }
});

// Export PNG (SVG → Canvas → PNG)
document.getElementById('exportPNG').onclick = ()=>{
  const svg = chart;
  const xml = new XMLSerializer().serializeToString(svg);
  const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
  const img = new Image();
  const w = svg.width.baseVal.value, h = svg.height.baseVal.value;
  img.onload = ()=>{
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    // white bg for light, dark bg otherwise
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel') || '#fff';
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img,0,0);
    const url = canvas.toDataURL('image/png');
    dl(url, 'unclenched-gantt.png');
  };
  img.src = svg64;
};

// Export CSV
document.getElementById('exportCSV').onclick = ()=>{
  const rows = [['id','name','start','end','progress','status','assignee','deps']];
  state.tasks.forEach(t=>{
    rows.push([t.id, t.name.replace(/,/g,' '), fmt(t.start), fmt(t.end), t.progress||0, t.status||'', t.assignee||'', (t.deps||[]).join('|')]);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  dl(URL.createObjectURL(blob), 'unclenched-gantt.csv');
};

// JSON modal
const jsonModal = document.getElementById('jsonModal');
document.getElementById('importJSON').onclick = ()=>{
  document.getElementById('jsonArea').value = JSON.stringify({tasks:state.tasks}, (k,v)=> v instanceof Date ? v.toISOString() : v, 2);
  jsonModal.classList.add('open'); jsonModal.setAttribute('aria-hidden','false');
};
document.getElementById('closeJSON').onclick = ()=>{ jsonModal.classList.remove('open'); jsonModal.setAttribute('aria-hidden','true'); };
document.getElementById('applyJSON').onclick = ()=>{
  try{
    const obj = JSON.parse(document.getElementById('jsonArea').value);
    state.tasks = (obj.tasks||[]).map(t=>({...t, start:new Date(t.start), end:new Date(t.end)}));
    calcBounds(); renderAll(); saveState();
    jsonModal.classList.remove('open');
  }catch(err){ alert('Invalid JSON'); }
};
document.getElementById('downloadJSON').onclick = ()=>{
  const txt = JSON.stringify({tasks:state.tasks}, (k,v)=> v instanceof Date ? v.toISOString() : v, 2);
  const blob = new Blob([txt], {type:'application/json'});
  dl(URL.createObjectURL(blob), 'unclenched-gantt.json');
};
document.getElementById('resetDemo').onclick = ()=>{
  if(confirm('Reset tasks to the demo dataset?')){ state.tasks = demo.tasks.map(t=>({...t})); calcBounds(); renderAll(); }
};

// Helper: download
function dl(url, name){
  const a = document.createElement('a');
  a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
}

// Resize observer: keep grid layer sized to SVG
new ResizeObserver(()=>{ renderChart(); }).observe(chartWrap);

// Initial render sizes
syncZoom();
</script>
</body>
</html>
