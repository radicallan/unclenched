
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
<title>Spirit Board — HOLD‑TO‑WRITE v5 (Mobile Layout)</title>
<style>
  :root{
    --bg:#0b0d12;--panel:#0f121a;--ink:#e7ebf2;--muted:#96a0b1;
    --header-h:44px;           /* compact top bar */
    --footer-h:28svh;          /* transcript panel */
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-t: env(safe-area-inset-top, 0px);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;height:100%;}
  .app{position:relative; min-height:100svh; min-height:100dvh;}
  header{
    position:fixed; inset:0 0 auto 0; height:var(--header-h);
    display:flex; align-items:center; gap:8px; padding:4px 8px;
    background:var(--panel); border-bottom:1px solid #1b2330; z-index:20;
  }
  button{appearance:none;border:1px solid #2a3a58;background:#0f1726;color:var(--ink);
    padding:6px 10px;border-radius:10px;cursor:pointer;font-size:14px;line-height:1}
  #status{margin-left:auto;color:#a9b3c6;font-size:12px}
  #stageWrap{
    position:fixed; left:0; right:0;
    top:var(--header-h);
    bottom:calc(var(--footer-h) + var(--safe-b));
    /* ensure canvas fills */
    display:block;
  }
  #cv{position:absolute; inset:0; width:100%; height:100%; display:block;
    touch-action:none; -webkit-user-select:none; user-select:none}
  footer{
    position:fixed; left:0; right:0; bottom:0;
    height:calc(var(--footer-h) + var(--safe-b));
    background:#0a0f16; border-top:1px solid #1b2330; padding:8px 8px calc(8px + var(--safe-b)) 8px;
    z-index:20;
  }
  .row{display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap}
  .row label{display:inline-flex; align-items:center; gap:6px; color:#cfe2ff; font-size:12px}
  input[type="range"]{accent-color:#2de2ff}
  textarea#ta{
    width:100%; height:calc(100% - 40px);
    background:#0b1018;color:#eaf2ff;border:1px solid #2a3a58;border-radius:10px;padding:10px;
    resize:none; font-family:ui-monospace,Menlo,Consolas,monospace
  }
  .tiny{font-size:12px;color:#9fb1c9}
</style>
</head>
<body>
<div class="app">
  <header>
    <button id="btnInvite">Invite</button>
    <button id="btnGoodbye">Goodbye</button>
    <button id="btnReset">Reset</button>
    <button id="btnFix">Close‑Letter Fix</button>
    <span id="status">Idle • 0 chars</span>
  </header>

  <div id="stageWrap"><canvas id="cv"></canvas></div>

  <footer>
    <div class="row">
      <label>Planchette <input id="rngPlan" type="range" min="16" max="44" step="1" value="24"></label>
      <label>Tile size <input id="rngTile" type="range" min="0.80" max="1.80" step="0.05" value="1.20"></label>
      <label>Arc width <input id="rngArc" type="range" min="0.70" max="0.92" step="0.01" value="0.88"></label>
      <label>Dwell <input id="rngDwell" type="range" min="400" max="1600" step="50" value="700"></label>
      <span class="tiny" id="dims"></span>
    </div>
    <textarea id="ta" readonly>(no text)</textarea>
  </footer>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const cv=$('#cv'), ctx=cv.getContext('2d',{alpha:true});
  const ta=$('#ta'), statusEl=$('#status'), dims=$('#dims');
  const DPR=Math.min(2, window.devicePixelRatio||1);
  let W=0,H=0, running=false, message="";
  // Controls (v4 defaults)
  let DWELL_MS=700, tileScale=1.20, planRpx=24, arcTight=0.88;
  // State
  const plan={x:0,y:0,r:28,trail:[]};
  const tiles=[];
  let entered=null, ready=0;
  const IN_FACTOR=1.22, OUT_FACTOR=1.60;
  // Commit rules (no distance gate; per‑tile lock + short time gap)
  let lastCommit=null; const MIN_GAP=220, REPEAT_CD=700;
  let touching=false, mouseDown=false;

  // Layout helpers
  function stageRectPx(){
    const wrap = document.getElementById('stageWrap');
    const r = wrap.getBoundingClientRect();
    return {w: Math.max(50, Math.floor(r.width*DPR)), h: Math.max(50, Math.floor(r.height*DPR))};
  }
  function sizeCanvas(){
    const r = stageRectPx();
    if(cv.width!==r.w) cv.width=r.w;
    if(cv.height!==r.h) cv.height=r.h;
    W=cv.width; H=cv.height;
    plan.r = Math.max(16*DPR, planRpx*DPR);
    buildTiles(); if(plan.x===0 && plan.y===0) center();
    draw();
    dims.textContent = Math.round(W/DPR)+'x'+Math.round(H/DPR)+'px';
  }
  // Handle 100vh quirks by re‑sizing on orientation/resize and after short delays
  new ResizeObserver(sizeCanvas).observe(document.getElementById('stageWrap'));
  window.addEventListener('orientationchange', ()=>{ setTimeout(sizeCanvas, 250); setTimeout(sizeCanvas, 800); });
  window.addEventListener('resize', ()=>{ setTimeout(sizeCanvas, 150); });
  setTimeout(sizeCanvas, 60); setTimeout(sizeCanvas, 300); setTimeout(sizeCanvas, 900);

  function center(){ plan.x=W*0.52; plan.y=H*0.62; draw(); }

  // Board layout
  const base = { r1:[...'ABCDEFGH'], r2:[...'IJKLMNOP'], r3:[...'QRSTUVWXYZ'], nums:[...'1234567890'], cor:['YES','NO','GOODBYE'] };
  function buildTiles(){
    tiles.length=0;
    const cx=W*0.52, cy=H*0.62, baseR=Math.min(W,H)*0.36;
    const a0 = -Math.PI*(arcTight), a1 = -Math.PI*(1.0-arcTight);
    const ring=(arr,r,idPrefix)=>{
      const n=arr.length;
      for(let i=0;i<n;i++){
        const t=i/(n-1), ang=a0+(a1-a0)*t, x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r;
        tiles.push({x,y,r:Math.min(W,H)*0.035*tileScale,label:arr[i], id:idPrefix+i});
      }
    };
    ring(base.r1, baseR*0.70, 'r1-');
    ring(base.r2, baseR*0.90, 'r2-');
    ring(base.r3, baseR*1.10, 'r3-');
    const nbY=cy+baseR*0.62, nr=Math.min(W,H)*0.035*tileScale;
    for(let i=0;i<base.nums.length;i++){
      const x=(W*0.20)+i*(W*0.6/(base.nums.length-1));
      tiles.push({x,y:nbY,r:nr,label:base.nums[i], id:'n-'+i});
    }
    const c=base.cor;
    tiles.push({x:W*0.18,y:H*0.16,r:Math.min(W,H)*0.045*tileScale,label:c[0], id:'y'});
    tiles.push({x:W*0.82,y:H*0.16,r:Math.min(W,H)*0.045*tileScale,label:c[1], id:'n'});
    tiles.push({x:W*0.50,y:H*0.16,r:Math.min(W,H)*0.045*tileScale,label:c[2], id:'g'});
  }

  // Draw board + planchette
  function drawBoard(){
    ctx.clearRect(0,0,W,H);
    const g=ctx.createRadialGradient(W*0.62,H*0.35,10, W*0.62,H*0.35, Math.max(W,H)*0.9);
    g.addColorStop(0,'rgba(255,255,255,0.06)'); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
    for(let y=0;y<H;y+=Math.max(24, 26*DPR)){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(W,y+0.5); ctx.stroke(); }
    for(let x=0;x<W;x+=Math.max(24, 26*DPR)){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,H); ctx.stroke(); }
    ctx.strokeStyle='rgba(200,210,230,0.10)'; ctx.lineWidth=Math.max(1, Math.min(W,H)*0.002);
    const cx=W*0.52, cy=H*0.62, baseR=Math.min(W,H)*0.36;
    [0.70, 0.90, 1.10].forEach(m=>{ ctx.beginPath(); ctx.arc(cx,cy,baseR*m,0,Math.PI*2); ctx.stroke(); });
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const fontBig=(Math.min(W,H)*0.048)+'px ui-monospace,Menlo,Consolas';
    const fontCor=(Math.min(W,H)*0.039)+'px ui-monospace,Menlo,Consolas';
    for(const t of tiles){
      if(t.label.length===1){ ctx.fillStyle='#cfd6e6'; ctx.font=fontBig; }
      else if(t.label==='YES'){ ctx.fillStyle='#7bf59a'; ctx.font=fontCor; }
      else if(t.label==='NO'){ ctx.fillStyle='#ffb3b3'; ctx.font=fontCor; }
      else { ctx.fillStyle='#9aa3b2'; ctx.font=fontCor; }
      ctx.fillText(t.label, t.x, t.y);
    }
    if(entered && entered.tile){
      const t=entered.tile, pct=ready;
      ctx.lineWidth=5;
      ctx.strokeStyle = (pct>=1 ? 'rgba(123,245,154,0.95)' : 'rgba(122,225,255,0.75)');
      ctx.beginPath(); ctx.arc(t.x, t.y, t.r*1.18, -Math.PI/2, (-Math.PI/2)+pct*2*Math.PI); ctx.stroke();
    }
  }
  function drawPlanchette(){
    const r=plan.r, x=plan.x, y=plan.y;
    ctx.strokeStyle='rgba(122,225,255,0.25)'; ctx.lineWidth=2;
    ctx.beginPath(); for(let i=0;i<plan.trail.length;i++){ const p=plan.trail[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);} ctx.stroke();
    ctx.fillStyle='rgba(16,24,36,0.92)'; ctx.strokeStyle='rgba(45,90,150,0.85)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.ellipse(x,y,r*1.05,r*0.95,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.10)'; ctx.beginPath(); ctx.arc(x,y,r*0.36,0,Math.PI*2); ctx.fill();
  }
  function draw(){ drawBoard(); drawPlanchette(); }

  // Hit & sticky
  function hit(x,y){ for(const t of tiles){ if(Math.hypot(x-t.x,y-t.y)<=t.r) return t; } return null; }
  function stickyHit(x,y){
    if(entered && entered.tile){
      const d=Math.hypot(x-entered.tile.x,y-entered.tile.y);
      if(d <= entered.tile.r*OUT_FACTOR) return entered.tile;
    }
    return hit(x,y);
  }

  // Commit gating
  function canCommit(tile, now){
    if(!entered || !entered.ready) return false;
    if(lastCommit){
      if(lastCommit.id===tile.id && (now-lastCommit.t) < REPEAT_CD) return false;
      if((now - lastCommit.t) < MIN_GAP) return false;
    }
    return true;
  }
  function commit(tile){
    const now=performance.now();
    if(!canCommit(tile, now)) return;
    const lab=tile.label;
    if(lab==='GOODBYE'){ message+=' [GOODBYE]'; running=false; }
    else if(lab==='YES' || lab==='NO'){ message+=` [${lab}]`; }
    else if(lab.length===1){ message+=lab; }
    lastCommit={id:tile.id, label:lab, x:tile.x, y:tile.y, t:now};
    if(entered) entered.didCommit=true;
    updateTranscript();
  }

  function updateTranscript(){
    ta.value = message || '(no text)';
    ta.scrollTop = ta.scrollHeight;
    statusEl.textContent = (running?'Listening':'Idle') + ' • ' + (message.replace(/\s/g,'').length) + ' chars';
  }

  // Dwell loop
  let lastTs=performance.now();
  function tick(ts){
    const dt = (ts - lastTs) || 16; lastTs = ts;
    if(touching || mouseDown){
      const tile = stickyHit(plan.x, plan.y);
      if(tile && (!entered || entered.tile!==tile)){
        entered = { tile, tEnter: ts, ready:false, didCommit:false };
        ready = 0;
      }
      if(tile){
        ready = Math.min(1, (ts - entered.tEnter) / DWELL_MS);
        entered.ready = ready >= 1;
        if(entered.ready && !entered.didCommit) commit(tile);
      }else{
        entered = null; ready = 0;
      }
    }else{
      entered = null; ready = 0;
    }
    draw();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Coords helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function toCanvas(clientX,clientY){ const r=cv.getBoundingClientRect(); return {x:(clientX-r.left)*DPR,y:(clientY-r.top)*DPR}; }

  // Touch
  cv.addEventListener('touchstart', e=>{ e.preventDefault(); touching=true;
    const t=e.changedTouches[0], p=toCanvas(t.clientX,t.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H); draw();
  }, {passive:false});
  cv.addEventListener('touchmove', e=>{ e.preventDefault();
    const t=e.changedTouches[0], p=toCanvas(t.clientX,t.clientY);
    plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H);
    plan.trail.push({x:plan.x,y:plan.y}); if(plan.trail.length>600) plan.trail.shift();
  }, {passive:false});
  cv.addEventListener('touchend', e=>{ e.preventDefault(); touching=false; }, {passive:false});
  cv.addEventListener('touchcancel', e=>{ e.preventDefault(); touching=false; }, {passive:false});

  // Mouse
  cv.addEventListener('mousedown', e=>{ mouseDown=true; const p=toCanvas(e.clientX,e.clientY); plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H); });
  cv.addEventListener('mousemove', e=>{ if(!mouseDown) return; const p=toCanvas(e.clientX,e.clientY); plan.x=clamp(p.x,0,W); plan.y=clamp(p.y,0,H); plan.trail.push({x:plan.x,y:plan.y}); if(plan.trail.length>600) plan.trail.shift(); });
  cv.addEventListener('mouseup', e=>{ mouseDown=false; });

  // UI
  $('#btnInvite').onclick=()=>{ running=true; message=''; plan.trail.length=0; entered=null; ready=0; updateTranscript(); draw(); };
  $('#btnGoodbye').onclick=()=>{ if(!running) return; commit({id:'g',label:'GOODBYE', x:0,y:0}); running=false; };
  $('#btnReset').onclick=()=>{ running=false; message=''; plan.trail.length=0; entered=null; ready=0; center(); updateTranscript(); draw(); };
  $('#btnFix').onclick=()=>{
    // Same close-letter preset as v4
    planRpx = 20; plan.r = planRpx*DPR;
    tileScale = 1.10; arcTight = 0.84; DWELL_MS = 650;
    buildTiles(); draw();
    $('#rngPlan').value = String(planRpx);
    $('#rngTile').value = String(tileScale);
    $('#rngArc').value  = String(arcTight);
    $('#rngDwell').value= String(DWELL_MS);
  };
  // Sliders
  $('#rngPlan').oninput=e=>{ planRpx = parseInt(e.target.value,10)||24; plan.r = planRpx*DPR; draw(); };
  $('#rngTile').oninput=e=>{ tileScale = parseFloat(e.target.value)||1.20; buildTiles(); draw(); };
  $('#rngArc').oninput=e=>{ arcTight = parseFloat(e.target.value)||0.88; buildTiles(); draw(); };
  $('#rngDwell').oninput=e=>{ DWELL_MS = parseInt(e.target.value,10)||700; };

  // Init
  updateTranscript();
})();
</script>
</body>
</html>
