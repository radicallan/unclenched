

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>ORACLE PRO v5.2 — Rescue Mode</title>
<style>
  :root{ --ink:#eaf2ff; --muted:#9fb1c9; --good:#8ef5c1; --warn:#ffd68a; --bad:#ff9b9b; }
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:#0a0f18;color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(120,160,220,.18);background:linear-gradient(180deg,#101829,#0b111e)}
  h1{font-size:16px;margin:0}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;color:#eaf2ff;background:linear-gradient(180deg,#2b79c2,#1a4a7f);font-weight:600}
  .ghost{background:linear-gradient(180deg,#1a263f,#121c33);border:1px solid rgba(120,160,220,.22)}
  main{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;padding:12px}
  .card{border:1px solid rgba(120,160,220,.18);border-radius:14px;background:rgba(14,20,32,.7);padding:12px;min-height:120px}
  canvas{display:block;width:100%;height:120px;background:linear-gradient(180deg,#0b1220,#0a0f18)}
  .pill{font-size:12px;color:var(--muted)}
  textarea{width:100%;height:190px;background:linear-gradient(180deg,#0b1220,#0a0f18);border:1px solid rgba(120,160,220,.18);border-radius:12px;color:#eaf2ff;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .log{height:140px;overflow:auto;border:1px solid rgba(120,160,220,.18);border-radius:10px;padding:6px;background:rgba(10,14,24,.6);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cfe3ff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .cands{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(120,160,220,.25);background:rgba(18,26,42,.6);color:#dfe8ff}
  .tag.top{border-color:#9fd;color:#9fd}
  @media (max-width: 900px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>ORACLE PRO v5.2 — Rescue Mode</h1>
  <div class="row">
    <button id="btnStart">Enable Mic</button>
    <button id="btnCal" class="ghost">Calibrate (10s)</button>
    <button id="btnQuick" class="ghost">QuickStart (lenient)</button>
    <button id="btnExport" class="ghost">Export Log</button>
    <button id="btnSafari" class="ghost">Safari Fix</button>
  </div>
</header>
<div id="msg" style="padding:10px" class="pill"></div>
<main>
  <div class="card">
    <div class="row"><span class="pill">Energy & Spectrum</span><span id="status" class="pill" style="margin-left:auto">Idle</span></div>
    <canvas id="meter"></canvas>
    <canvas id="spec"></canvas>
    <div id="diag" class="pill" style="margin-top:6px"></div>
  </div>
  <div class="card">
    <div class="row"><span class="pill">Top Candidates</span></div>
    <div id="cands" class="cands"></div>
    <div class="row" style="margin-top:8px"><span class="pill">Transcript</span></div>
    <textarea id="ta" readonly>(no text)</textarea>
    <div class="row" style="margin-top:8px"><span class="pill">Log</span></div>
    <div id="log" class="log"></div>
  </div>
</main>

<script>
(() => {
  const CORE = ["ABOUT", "ABOVE", "ACCEPT", "ACCESS", "ACTION", "ACTIVE", "ADVICE", "AFTER", "AGAIN", "AGAINST", "AGREE", "ALLOW", "ALMOST", "ALONE", "ALONG", "ALSO", "ALWAYS", "AMOUNT", "ANALYSE", "ANSWER", "ANYONE", "ANYTHING", "APPEAR", "APPLY", "AREA", "AROUND", "ARRIVE", "ASK", "ASSESS", "ASSIST", "ATTEND", "AWARE", "AWAY", "BALANCE", "BASIC", "BEAR", "BECOME", "BEFORE", "BEGIN", "BELIEVE", "BELONG", "BELOW", "BENEFIT", "BETWEEN", "BEYOND", "BLACK", "BLOOD", "BLUE", "BOARD", "BODY", "BOLD", "BOOK", "BOTH", "BOTTOM", "BRAIN", "BRANCH", "BRAND", "BRAVE", "BREAD", "BREAK", "BREATH", "BRIDGE", "BRIGHT", "BRING", "BROTHER", "BROWN", "BUILD", "BURN", "BUSINESS", "BUSY", "BUY", "CALL", "CALM", "CAMERA", "CANCEL", "CAPABLE", "CARBON", "CARE", "CAREER", "CAREFUL", "CARRY", "CASE", "CASH", "CAUSE", "CEILING", "CENTER", "CENTRE", "CERTAIN", "CHAIR", "CHANCE", "CHANGE", "CHARGE", "CHART", "CHECK", "CHOICE", "CHOOSE", "CIRCLE", "CITY", "CLAIM", "CLASS", "CLEAN", "CLEAR", "CLIENT", "CLIMATE", "CLIMB", "CLOCK", "CLOSE", "CLOUD", "CLUB", "CLUE", "COACH", "COAST", "CODE", "COFFEE", "COLD", "COLLECT", "COLOUR", "COMBINE", "COMFORT", "COMMON", "COMPANY", "COMPARE", "COMPETE", "COMPLETE", "COMPLEX", "COMPLY", "CONNECT", "CONSENT", "CONSIDER", "CONTACT", "CONTAIN", "CONTENT", "CONTEXT", "CONTINUE", "CONTRACT", "CONTROL", "CONVERT", "COOK", "COOL", "COPY", "CORNER", "CORRECT", "COST", "COULD", "COUNCIL", "COUNT", "COUNTRY", "COUPLE", "COURSE", "COVER", "CREATE", "CREDIT", "CREW", "CRISIS", "CRITERIA", "CROSS", "CROWD", "CULTURE", "CURRENT", "CUSTOMER", "CYCLE", "DAILY", "DAMAGE", "DANGER", "DARK", "DATA", "DATE", "DAY", "DEAL", "DEAR", "DEATH", "DEBATE", "DEBT", "DECIDE", "DECISION", "DECLINE", "DEEP", "DEFAULT", "DEFEND", "DEFINE", "DEGREE", "DELAY", "DELIVER", "DEMAND", "DENY", "DEPART", "DEPEND", "DESCRIBE", "DESIGN", "DESIRE", "DESPITE", "DETAIL", "DETECT", "DEVELOP", "DEVICE", "DIFFER", "DIRECT", "DISABLE", "DISCOVER", "DISCUSS", "DISEASE", "DISMISS", "DISPLAY", "DISTANCE", "DISTINCT", "DIVIDE", "DOCTOR", "DOCUMENT", "DOOR", "DOUBLE", "DOUBT", "DOWN", "DRAFT", "DRAW", "DREAM", "DRESS", "DRINK", "DRIVE", "DROP", "DRY", "DURING", "DUTY", "EACH", "EARLY", "EARN", "EARTH", "EAST", "EASY", "EAT", "EFFECT", "EFFORT", "EITHER", "EMAIL", "EMERGE", "EMOTION", "EMPLOY", "ENABLE", "ENCOURAGE", "END", "ENEMY", "ENERGY", "ENJOY", "ENOUGH", "ENSURE", "ENTER", "ENTIRE", "ENTRY", "ENVIRONMENT", "EQUAL", "EQUIP", "ERROR", "ESCAPE", "ESPECIALLY", "ESSENTIAL", "ESTABLISH", "ESTATE", "ESTIMATE", "EVEN", "EVENING", "EVENT", "EVERY", "EVIDENCE", "EXACT", "EXAMPLE", "EXCEED", "EXCEPT", "EXCHANGE", "EXERCISE", "EXIST", "EXIT", "EXPECT", "EXPENSE", "EXPERIENCE", "EXPERT", "EXPLAIN", "EXPLORE", "EXPRESS", "EXTEND", "EXTRA", "FACE", "FACTOR", "FAIL", "FAIR", "FAITH", "FALL", "FAMILY", "FAMOUS", "FANCY", "FAST", "FATHER", "FAULT", "FAVOUR", "FEAR", "FEATURE", "FEEL", "FEMALE", "FIELD", "FIGHT", "FIGURE", "FILE", "FILL", "FINAL", "FINANCE", "FIND", "FINE", "FINISH", "FIRE", "FIRST", "FISH", "FIT", "FIX", "FLAG", "FLAME", "FLAT", "FLIGHT", "FLOOR", "FLOW", "FLY", "FOLLOW", "FOOD", "FOOT", "FORCE", "FORGET", "FORGIVE", "FORM", "FORMAL", "FORMER", "FORTUNE", "FORWARD", "FOUND", "FRAME", "FREE", "FREEDOM", "FRESH", "FRIEND", "FRONT", "FROZEN", "FUEL", "FULL", "FUNCTION", "FUND", "FUNNY", "FUTURE", "GAIN", "GALLERY", "GAME", "GARDEN", "GAS", "GATE", "GATHER", "GENDER", "GENERAL", "GENERATE", "GENUINE", "GHOST", "GIFT", "GIVE", "GLASS", "GLOBAL", "GOAL", "GOOD", "GOVERNMENT", "GRACE", "GRADE", "GRANT", "GREAT", "GREEN", "GROUND", "GROUP", "GROW", "GROWTH", "GUARD", "GUESS", "GUEST", "GUIDE", "HABIT", "HALF", "HAND", "HANDLE", "HANG", "HAPPEN", "HAPPY", "HARD", "HARM", "HATE", "HEAD", "HEALTH", "HEAR", "HEART", "HEAT", "HEAVY", "HEIGHT", "HELLO", "HELP", "HERE", "HERO", "HIDE", "HIGH", "HILL", "HINT", "HISTORY", "HOLD", "HOLE", "HOLIDAY", "HOME", "HONEST", "HONOUR", "HOPE", "HORROR", "HOSPITAL", "HOST", "HOTEL", "HOUR", "HOUSE", "HUMAN", "HUNGRY", "HURRY", "HURT", "IDEA", "IDEAL", "IDENTIFY", "IMAGE", "IMAGINE", "IMPACT", "IMPROVE", "INCLUDE", "INCOME", "INCREASE", "INDICATE", "INDUSTRY", "INFLUENCE", "INFORM", "INITIAL", "INJURY", "INNER", "INNOVATE", "INSIDE", "INSIGHT", "INSIST", "INSPECT", "INSPIRE", "INSTALL", "INSTANT", "INSTEAD", "INSTRUCT", "INSURE", "INTEND", "INTEREST", "INTERNAL", "INTERNET", "INTERVIEW", "INTRODUCE", "INVEST", "INVITE", "INVOLVE", "IRON", "ISSUE", "ITEM", "JOB", "JOIN", "JOY", "JUDGE", "JUMP", "JUSTICE", "KEEP", "KID", "KIND", "KING", "KITCHEN", "KNEE", "KNOW", "KNOWLEDGE", "LAB", "LABEL", "LABOUR", "LACK", "LADDER", "LAND", "LANDLORD", "LANDSCAPE", "LANGUAGE", "LARGE", "LAST", "LATE", "LATER", "LAUGH", "LAUNCH", "LAW", "LAYER", "LEAD", "LEADER", "LEARN", "LEAST", "LEAVE", "LEFT", "LEG", "LEGAL", "LEGEND", "LEND", "LENGTH", "LESSON", "LETTER", "LEVEL", "LIBRARY", "LIFE", "LIFT", "LIGHT", "LIKE", "LIMIT", "LINE", "LINK", "LIST", "LISTEN", "LITTLE", "LIVE", "LOAD", "LOAN", "LOCAL", "LOCATE", "LOCATION", "LOCK", "LOGIC", "LONG", "LOOK", "LOSE", "LOSS", "LOST", "LOUD", "LOVE", "LOWER", "LUCK", "LUNCH", "MACHINE", "MAGIC", "MAIL", "MAIN", "MAJOR", "MAKE", "MAN", "MANAGE", "MANNER", "MANY", "MAP", "MARKET", "MARRIED", "MATCH", "MATERIAL", "MATTER", "MAYBE", "MEAL", "MEAN", "MEASURE", "MEDIA", "MEDICAL", "MEET", "MEMBER", "MEMORY", "MENTAL", "MENTION", "MENU", "MESSAGE", "METAL", "MIDDLE", "MIGHT", "MILLION", "MIND", "MINOR", "MINUTE", "MIRROR", "MISSION", "MISTAKE", "MIX", "MOBILE", "MODEL", "MODERN", "MOMENT", "MONEY", "MONTH", "MOOD", "MORE", "MORNING", "MOTHER", "MOTION", "MOUNTAIN", "MOUTH", "MOVE", "MOVEMENT", "MOVIE", "MUSIC", "MUST", "NAME", "NARROW", "NATION", "NATIONAL", "NATIVE", "NATURE", "NEAR", "NEAT", "NECESSARY", "NEED", "NEGLECT", "NEITHER", "NERVOUS", "NETWORK", "NEVER", "NEW", "NEWS", "NEXT", "NICE", "NIGHT", "NOBODY", "NOISE", "NONE", "NORMAL", "NORTH", "NOTE", "NOTHING", "NOTICE", "NUMBER", "NURSE", "OBJECT", "OBSERVE", "OBTAIN", "OBVIOUS", "OCCASION", "OCCUPY", "OCCUR", "OFFER", "OFFICE", "OFFICER", "OFFICIAL", "OFTEN", "OIL", "OKAY", "OLD", "ONCE", "ONE", "ONLY", "OPEN", "OPERATE", "OPINION", "OPPOSITE", "OPTION", "ORDER", "ORDINARY", "ORGANISE", "ORIGINAL", "OTHER", "OUT", "OUTCOME", "OUTSIDE", "OVER", "OWN", "OWNER", "PACE", "PACK", "PAGE", "PAIN", "PAINT", "PAIR", "PAPER", "PARENT", "PARK", "PARTNER", "PARTY", "PASS", "PAST", "PATH", "PATIENT", "PATTERN", "PAY", "PAYMENT", "PEACE", "PEAK", "PEOPLE", "PERFECT", "PERFORM", "PERHAPS", "PERIOD", "PERMIT", "PERSON", "PERSONAL", "PHONE", "PHOTO", "PHYSICAL", "PICK", "PICTURE", "PIECE", "PINK", "PLACE", "PLAN", "PLANE", "PLANT", "PLASTIC", "PLATE", "PLATFORM", "PLAY", "PLEASURE", "PLOT", "PLUS", "POCKET", "POINT", "POLICE", "POLICY", "POLITE", "POOL", "POOR", "POPULAR", "POSITION", "POSITIVE", "POSSIBLE", "POST", "POTENTIAL", "POWER", "PRACTICE", "PRAISE", "PREPARE", "PRESENT", "PRESS", "PRESSURE", "PREVENT", "PRICE", "PRIDE", "PRIMARY", "PRINCIPLE", "PRINT", "PRIOR", "PRISON", "PRIVATE", "PRIZE", "PROBLEM", "PROCESS", "PRODUCE", "PRODUCT", "PROFESSIONAL", "PROFILE", "PROFIT", "PROGRAM", "PROJECT", "PROMISE", "PROOF", "PROPER", "PROPERTY", "PROTECT", "PROVE", "PROVIDE", "PUBLIC", "PURPOSE", "PUSH", "PUT", "QUALITY", "QUESTION", "QUICK", "QUIET", "QUOTE", "RACE", "RADIO", "RAIN", "RAISE", "RANGE", "RATE", "RATHER", "REACH", "REACT", "READ", "READY", "REAL", "REALISE", "REALLY", "REASON", "RECEIVE", "RECENT", "RECORD", "RECOVER", "RED", "REDUCE", "REFER", "REFLECT", "REFRESH", "REFUND", "REFUSE", "REGARD", "REGION", "REGISTER", "REGRET", "REGULAR", "RELATE", "RELAX", "RELEASE", "RELIEF", "RELY", "REMAIN", "REMEMBER", "REMIND", "REMOVE", "RENT", "REPAIR", "REPEAT", "REPLACE", "REPLY", "REPORT", "REPRESENT", "REQUEST", "REQUIRE", "RESCUE", "RESEARCH", "RESIDENT", "RESIST", "RESPECT", "RESPOND", "RESULT", "RETURN", "REVEAL", "REVIEW", "REWARD", "RIDE", "RIGHT", "RING", "RISK", "ROAD", "ROLE", "ROLL", "ROOF", "ROOM", "ROOT", "ROUGH", "ROUND", "ROUTE", "ROYAL", "RULE", "RUN", "RURAL", "RUSH", "SAFE", "SAFETY", "SAID", "SAIL", "SALARY", "SALE", "SAME", "SAMPLE", "SAVE", "SAY", "SCALE", "SCENE", "SCHOOL", "SCIENCE", "SCORE", "SCREEN", "SEARCH", "SEASON", "SEAT", "SECOND", "SECRET", "SECTION", "SECURE", "SEEK", "SEEM", "SELECT", "SELF", "SELL", "SEND", "SENIOR", "SENSE", "SENTENCE", "SEPARATE", "SERIES", "SERIOUS", "SERVE", "SERVICE", "SESSION", "SET", "SETTLE", "SEVEN", "SEVERAL", "SHADE", "SHAKE", "SHAPE", "SHARE", "SHARP", "SHEET", "SHELTER", "SHINE", "SHIP", "SHIRT", "SHOCK", "SHOE", "SHOOT", "SHOP", "SHORT", "SHOULD", "SHOULDER", "SHOUT", "SHOW", "SHUT", "SIDE", "SIGHT", "SIGN", "SIGNAL", "SIGNIFICANT", "SILENT", "SILVER", "SIMPLE", "SIMPLY", "SING", "SISTER", "SITE", "SITUATION", "SIZE", "SKILL", "SLEEP", "SLOW", "SMALL", "SMART", "SMELL", "SMILE", "SMOKE", "SMOOTH", "SNOW", "SOCIAL", "SOCIETY", "SOFT", "SOFTWARE", "SOLUTION", "SOME", "SOMEONE", "SOMETHING", "SOMEWHERE", "SONG", "SOON", "SORRY", "SORT", "SOUND", "SOURCE", "SOUTH", "SPACE", "SPEAK", "SPECIAL", "SPECIFIC", "SPEECH", "SPEED", "SPEND", "SPIRIT", "SPORT", "SPOT", "SPRING", "SQUARE", "STAGE", "STAND", "STANDARD", "STAR", "START", "STATE", "STATION", "STAY", "STEEL", "STEP", "STILL", "STOCK", "STONE", "STOP", "STORE", "STORM", "STORY", "STRAIGHT", "STRANGE", "STRATEGY", "STREET", "STRENGTH", "STRESS", "STRICT", "STRIKE", "STRING", "STRONG", "STRUCTURE", "STUDENT", "STUDY", "STYLE", "SUBJECT", "SUBMIT", "SUBSCRIBE", "SUCCESS", "SUCH", "SUDDEN", "SUGAR", "SUIT", "SUMMER", "SUN", "SUNDAY", "SUPPLY", "SUPPORT", "SUPPOSE", "SURE", "SURFACE", "SURPRISE", "SURROUND", "SURVEY", "SURVIVE", "SYSTEM", "TABLE", "TACKLE", "TAIL", "TAKE", "TALK", "TALL", "TAPE", "TARGET", "TASK", "TASTE", "TAX", "TEACH", "TEAM", "TECHNICAL", "TECHNOLOGY", "TEETH", "TELEPHONE", "TELEVISION", "TELL", "TEMPORARY", "TEND", "TENDER", "TERM", "TERRIBLE", "TEST", "TEXT", "THAN", "THANK", "THAT", "THE", "THEIR", "THEM", "THEME", "THEN", "THEORY", "THERE", "THESE", "THEY", "THICK", "THIN", "THING", "THINK", "THIRD", "THIS", "THOUGHT", "THOUSAND", "THREAT", "THREE", "THROAT", "THROUGH", "THROW", "THURSDAY", "TICKET", "TIDY", "TIE", "TIGHT", "TIME", "TINY", "TITLE", "TODAY", "TOGETHER", "TOMORROW", "TONE", "TONGUE", "TONIGHT", "TOOL", "TOP", "TOPIC", "TOTAL", "TOUCH", "TOWN", "TRACK", "TRADE", "TRAFFIC", "TRAIN", "TRANSFER", "TRAVEL", "TREAT", "TREE", "TREND", "TRIAL", "TRIP", "TROUBLE", "TRUE", "TRUST", "TRUTH", "TRY", "TUESDAY", "TURN", "TWICE", "TYPE", "UNDER", "UNDERSTAND", "UNIT", "UNIVERSITY", "UNLESS", "UNLIKE", "UNLOCK", "UNTIL", "UPDATE", "UPPER", "URBAN", "URGENT", "US", "USE", "USUAL", "VACANT", "VALUE", "VARIOUS", "VAST", "VEHICLE", "VENTURE", "VERSION", "VERY", "VICTORY", "VIDEO", "VIEW", "VILLAGE", "VISION", "VISIT", "VISUAL", "VITAL", "VOICE", "VOLUME", "VOTE", "WAIT", "WAKE", "WALK", "WALL", "WANT", "WAR", "WARM", "WARN", "WASH", "WASTE", "WATCH", "WATER", "WAVE", "WAY", "WEAK", "WEALTH", "WEAR", "WEATHER", "WEDNESDAY", "WEEK", "WELCOME", "WELL", "WEST", "WHAT", "WHEEL", "WHEN", "WHERE", "WHETHER", "WHICH", "WHILE", "WHISPER", "WHITE", "WHO", "WHOLE", "WHOM", "WHOSE", "WHY", "WIDE", "WIFE", "WILD", "WILL", "WIND", "WINDOW", "WING", "WINNER", "WINTER", "WIRE", "WISDOM", "WISH", "WITH", "WITHIN", "WITHOUT", "WITNESS", "WOMAN", "WONDER", "WOOD", "WORD", "WORK", "WORLD", "WORRY", "WORTH", "WOULD", "WRITE", "WRONG", "YARD", "YEAR", "YELLOW", "YES", "YET", "YOUNG", "YOUR", "YOURSELF"];
  const $=s=>document.querySelector(s);
  const meter=$('#meter'), mtx=meter.getContext('2d');
  const spec=$('#spec'), stx=spec.getContext('2d');
  const statusEl=$('#status'), diag=$('#diag'), ta=$('#ta'), logEl=$('#log'), msgEl=$('#msg');
  function log(msg){ const ts=new Date().toLocaleTimeString(); logEl.innerHTML='['+ts+'] '+msg+'<br>'+logEl.innerHTML; logEl.innerHTML=logEl.innerHTML.split('<br>').slice(0,180).join('<br>'); }
  function status(s){ statusEl.textContent=s; }

  let audio, analyser, hp, lp, freqBuf, timeBuf, running=false;
  let baseline=0, ema=0, overStreak=0, zEMA=0, lastCommit=0, coolUntil=0, sessionStart=0;
  let assists=0;

  // Lenient defaults
  const cfg = { cutoff:190, sens:1.16, cool:3000, conf:0.25 };
  let strictValley=true; // will be temporarily relaxed by rescue

  async function getMic(kind='normal'){
    try{
      if(location.protocol==='file:'){ msgEl.innerHTML='Note: mic may be blocked on <code>file://</code>. Run on http://localhost or HTTPS.'; }
      if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) throw new Error('getUserMedia not available');
      audio = audio || new (window.AudioContext||window.webkitAudioContext)();
      if(kind==='safari'){
        const osc=audio.createOscillator(); const dst=audio.createMediaStreamDestination(); osc.connect(dst); osc.start(); osc.stop(audio.currentTime+0.05); await audio.resume();
      } else { if(audio.state==='suspended'){ await audio.resume(); } }
      const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true, noiseSuppression:false, autoGainControl:false}});
      const src=audio.createMediaStreamSource(stream);
      hp=audio.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=20;
      lp=audio.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=cfg.cutoff;
      analyser=audio.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
      freqBuf=new Uint8Array(analyser.frequencyBinCount); timeBuf=new Float32Array(analyser.fftSize);
      src.connect(hp).connect(lp).connect(analyser);
      running=true; status('Mic ready'); log('Mic ready');
      sessionStart=performance.now(); lastCommit=0; coolUntil=0; assists=0;
      loop();
      return true;
    }catch(e){
      const msg=(e&&e.name?e.name+': ':'')+(e.message||e);
      status('Mic error'); diag.textContent='Mic access failed: '+msg; msgEl.innerHTML='Mic access failed: '+msg;
      log('Mic error: '+msg); return false;
    }
  }

  function lfEnergy(){ if(!analyser) return 0; analyser.getByteFrequencyData(freqBuf);
    const nyq=audio.sampleRate/2, binHz=nyq/freqBuf.length, maxBin=Math.min(freqBuf.length-1, Math.floor(cfg.cutoff/binHz));
    let sum=0; for(let i=0;i<=maxBin;i++) sum+=freqBuf[i]; return sum/(maxBin+1); }
  function centroid(){ analyser.getByteFrequencyData(freqBuf); const nyq=audio.sampleRate/2, binHz=nyq/freqBuf.length; let num=0,den=0; for(let i=0;i<freqBuf.length;i++){ const f=i*binHz, a=freqBuf[i]; num+=f*a; den+=a; } return den>0?num/den:0; }
  function zcr(){ analyser.getFloatTimeDomainData(timeBuf); let z=0; for(let i=1;i<timeBuf.length;i++){ const a=timeBuf[i-1], b=timeBuf[i]; if((a>=0&&b<0)||(a<0&&b>=0)) z++; } return z/timeBuf.length; }

  function drawMeter(e, base, over=false){
    const W=meter.clientWidth,H=meter.clientHeight; if(meter.width!==W) meter.width=W; if(meter.height!==H) meter.height=H;
    mtx.clearRect(0,0,W,H);
    const thr=base*cfg.sens; const pct=Math.max(0,Math.min(1, thr>0 ? e/thr : 0));
    mtx.fillStyle= over?'rgba(159,253,221,0.4)':'rgba(159,253,221,0.25)'; mtx.fillRect(0,H*(1-pct),W,H*pct);
    mtx.fillStyle='rgba(220,235,255,0.9)'; mtx.font='12px ui-sans-serif'; mtx.fillText('E:'+e.toFixed(1)+' Thr:'+thr.toFixed(1)+' x='+pct.toFixed(2),8,16);
  }
  function drawSpec(empty){
    const W=spec.clientWidth,H=spec.clientHeight; if(spec.width!==W) spec.width=W; if(spec.height!==H) spec.height=H;
    stx.clearRect(0,0,W,H); if(!analyser||empty) return;
    analyser.getByteFrequencyData(freqBuf);
    const nyq=(audio?audio.sampleRate:44100)/2, binHz=nyq/freqBuf.length; const maxBin=Math.min(freqBuf.length-1, Math.floor(cfg.cutoff/binHz)); const barW=Math.max(1,W/(maxBin+1));
    for(let i=0;i<=maxBin;i++){ const v=freqBuf[i]/255, h=v*H; stx.fillStyle='rgba(122,225,255,0.45)'; stx.fillRect(i*barW, H-h, barW-1, h); }
  }

  const COMMON_DAMP = new Set(['SEE','YES','NO','CAT','ECO']);
  function scoreWord(w, e){
    const L=w.toUpperCase(); const len=L.length;
    let s = -Math.abs(len-6)*1.2;
    const v=(L.match(/[AEIOU]/g)||[]).length; const vr=v/Math.max(1,len);
    s += (0.8 - Math.abs(vr-0.42))*0.6;
    const thr = baseline*cfg.sens;
    if(COMMON_DAMP.has(L) && e < thr*1.2) s -= 1.0;
    s += (Math.random()-0.5)*0.02;
    return s;
  }

  const recent=[]; const shadow=new Map();
  function banned(w, now){ const u=shadow.get(w); if(u&&now<u) return true; return recent.slice(-10).some(x=>x===w); }
  function pushRecent(w){ const now=performance.now(); recent.push(w); while(recent.length>120) recent.shift(); const last8=recent.slice(-8); const c=last8.filter(x=>x===w).length; if(c>=2){ shadow.set(w, now+90000); log('Shadow-ban '+w+' for 90s'); } }

  function candidates(e){
    const now=performance.now(); const arr=[];
    for(const w of CORE){ const L=w.toUpperCase(); if(banned(L, now)) continue; arr.push([L, scoreWord(L, e)]); }
    arr.sort((a,b)=>b[1]-a[1]); return arr.slice(0,6);
  }

  let relaxUntil=0, tempConfUntil=0;

  function emit(tok){
    const now=performance.now();
    ta.value = (ta.value==='(no text)') ? tok : (ta.value + ' ' + tok);
    ta.scrollTop = ta.scrollHeight;
    pushRecent(tok);
    lastCommit=now; coolUntil=now+cfg.cool;
    log('Commit: '+tok);
  }

  async function calibrate(){
    if(!running){ await getMic(); if(!running) return; }
    status('Calibrating...'); log('Calibration 10s');
    let acc=0,n=0; const t0=performance.now();
    while(performance.now()-t0<10000){ acc+=lfEnergy(); n++; await new Promise(r=>setTimeout(r,50)); }
    baseline=acc/Math.max(1,n); ema=baseline; status('Calibrated'); log('Baseline '+baseline.toFixed(1));
  }

  async function enableMic(){ await getMic(); }

  function assist(now, since){
    if(assists>=3) return;
    if(since>25000 && assists===0){ cfg.sens=Math.max(1.06,cfg.sens*0.97); baseline=baseline*0.99; assists++; log('Assist: slight sensitivity drop'); }
    else if(since>40000 && assists===1){ relaxUntil=now+10000; assists++; log('Assist: relaxed valley 10s'); }
    else if(since>55000 && assists===2){ tempConfUntil=now+12000; assists++; log('Assist: lowered confidence 12s'); }
  }

  function loop(){
    if(!running){ drawMeter(0,0); drawSpec(true); return; }
    const e=lfEnergy(); ema=ema+(e-ema)*0.02; baseline=baseline*0.995+ema*0.005;
    const thr=baseline*cfg.sens; const over=e>thr;
    const z=zcr(); zEMA=zEMA*0.9+z*0.1; const valley=z<zEMA*0.85;
    overStreak=over?Math.min(overStreak+1,120):Math.max(0,overStreak-1);
    drawMeter(e,baseline,over); drawSpec();

    const list=candidates(e);
    const now=performance.now();
    const valleyOk = (now>=relaxUntil) ? (!strictValley || valley) : true;
    const conf = (now<tempConfUntil) ? Math.max(0.18, cfg.conf*0.8) : cfg.conf;

    if(now>=coolUntil && overStreak>=6 && valleyOk){
      if(list.length>=2 && (list[0][1]-list[1][1])>=conf){
        emit(list[0][0]);
      }
    }

    // Rescue: if no commit after 75s, force a commit on next overStreak
    const since = lastCommit ? (now-lastCommit) : (now-sessionStart);
    if(since>75000 && overStreak>=4 && list.length){
      emit(list[0][0]);
      log('Rescue commit');
    }

    assist(now, since);
    requestAnimationFrame(loop);
  }

  // Buttons
  document.getElementById('btnStart').onclick=enableMic;
  document.getElementById('btnCal').onclick=calibrate;
  document.getElementById('btnSafari').onclick=async()=>{ await getMic('safari'); };
  document.getElementById('btnQuick').onclick=()=>{
    // Apply lenient QuickStart
    strictValley=false; cfg.sens=1.18; cfg.cutoff=180; cfg.cool=2800; baseline=baseline*0.98; log('QuickStart applied');
    if(lp) lp.frequency.value=cfg.cutoff;
  };

  // Export
  document.getElementById('btnExport').onclick=()=>{
    const lines = logEl.innerText.split('\\n').reverse();
    const out = [
      '# ORACLE PRO v5.2 — Rescue Mode',
      'Time: '+new Date().toISOString(),
      'Cutoff: '+cfg.cutoff+' Hz; Sens: '+cfg.sens.toFixed(2)+'x; Cooldown: '+cfg.cool+' ms; Conf: '+cfg.conf.toFixed(2),
      'Strict valley: '+strictValley,
      '',
      'Transcript:',
      ta.value,
      '',
      'Diagnostics (oldest → newest):',
      ...lines
    ].join('\\n');
    const blob = new Blob([out], {type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oracle_pro_v5_2_rescue_session.txt'; a.click(); URL.revokeObjectURL(a.href);
  };

  log('Ready');
})();
</script>
</body>
</html>
