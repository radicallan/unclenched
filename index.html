<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ITC Digital Conduit // v2.0</title>
    <style>
        /* AESTHETIC: High-Tech Occult / Terminal Style */
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
        }

        h1 { margin-bottom: 5px; font-size: 1.2rem; opacity: 0.7; }

        /* The main "Word" display */
        #output {
            font-size: 4rem;
            height: 1.2em;
            margin: 20px 0;
            text-shadow: 0 0 15px #00ff41, 0 0 30px #00ff41;
            letter-spacing: 5px;
        }

        /* The visualizer canvas */
        canvas {
            width: 80%;
            height: 150px;
            background: #001100;
            border: 1px solid #003300;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        /* Controls UI */
        .controls {
            margin-top: 20px;
            padding: 20px;
            background: #111;
            display: inline-block;
            border: 1px solid #333;
        }

        input[type=range] { width: 200px; accent-color: #00ff41; }
        label { display: block; margin-bottom: 10px; font-size: 0.8rem; }
        
        button {
            background: transparent;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 10px 30px;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        button:hover { background: #00ff41; color: black; box-shadow: 0 0 15px #00ff41; }
        
        #status { font-size: 0.7rem; color: #555; margin-top: 10px; }
        .log-box {
            font-size: 0.8rem;
            color: #008f11;
            margin-top: 20px;
            height: 100px;
            overflow-y: auto;
            border-top: 1px solid #333;
            width: 60%;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            padding: 10px;
        }
    </style>
</head>
<body>

    <h1>ITC DIGITAL CONDUIT</h1>
    
    <canvas id="visualizer"></canvas>

    <div id="output">...</div>

    <div class="controls">
        <label>SENSITIVITY THRESHOLD (Trigger Level)</label>
        <input type="range" id="sensitivity" min="0" max="255" value="130">
        <br><br>
        <button id="startBtn">INITIALIZE SYSTEM</button>
        <div id="status">System Standby...</div>
    </div>

    <div class="log-box" id="history">
        [SESSION LOG STARTED...]
    </div>

    <script>
        // === THE WORD BANK ===
        // A mix of binary responses, emotional states, and environmental concepts
        const dictionary = [
            "YES", "NO", "WAIT", "NEAR", "FAR", "ENERGY", "COLD", "HEAT",
            "LOOK", "LISTEN", "RUN", "HELP", "PEACE", "TRAPPED", "LIGHT",
            "DARKNESS", "TIME", "NAME", "BELOW", "ABOVE", "WATER", "FIRE",
            "MOTHER", "FATHER", "CHILD", "DEATH", "LIFE", "PATH", "DOOR",
            "OPEN", "CLOSE", "SEE", "HIDE", "SPEAK", "SIGNAL", "TECH"
        ];

        let audioCtx, analyser, source, bufferLength, dataArray;
        let isRunning = false;
        let lastTriggerTime = 0;
        const cooldown = 1500; // ms to wait between words (prevents spamming)

        const canvas = document.getElementById("visualizer");
        const ctx = canvas.getContext("2d");
        const output = document.getElementById("output");
        const statusDiv = document.getElementById("status");
        const historyDiv = document.getElementById("history");
        const sensitivitySlider = document.getElementById("sensitivity");
        const startBtn = document.getElementById("startBtn");

        // === INITIALIZE AUDIO ENGINE ===
        startBtn.addEventListener("click", async () => {
            if (isRunning) return; // Prevent double click
            
            try {
                // 1. Request Microphone Access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Create Web Audio Context
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                
                // 3. Setup Analyzer (High Resolution for detailed frequency data)
                analyser.fftSize = 2048; 
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // 4. Connect Mic to Analyzer
                source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);

                isRunning = true;
                statusDiv.innerText = "SYSTEM ACTIVE - LISTENING FOR ENERGY SPIKES...";
                startBtn.style.display = "none";
                
                // Start the visualizer and listening loop
                draw();

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "ERROR: MICROPHONE ACCESS DENIED.";
            }
        });

        // === THE MAIN LOOP ===
        function draw() {
            if (!isRunning) return;

            requestAnimationFrame(draw);

            // Get Frequency Data (The "Fingerprint" of the sound)
            analyser.getByteFrequencyData(dataArray);

            // 1. VISUALIZER LOGIC (Draw the green energy wave)
            ctx.fillStyle = "#001100"; // Clear screen with dark green
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#00ff41";
            ctx.beginPath();

            // Calculate width of each bar in the wave
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            
            // Calculate Average Volume for the Trigger Logic
            let sum = 0;
            let maxFreqIndex = 0; // To track dominant pitch
            let maxFreqValue = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0; // Normalize 0-255 to 0-2 height
                const y = v * canvas.height / 2;

                // Draw wave line
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);

                x += sliceWidth;
                
                // Analyze Volume & Pitch
                sum += dataArray[i];
                if (dataArray[i] > maxFreqValue) {
                    maxFreqValue = dataArray[i];
                    maxFreqIndex = i; // Save which frequency band is loudest
                }
            }

            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            // 2. THE TRIGGER LOGIC (Ghost Detection)
            const averageVolume = sum / bufferLength;
            const threshold = sensitivitySlider.value / 2; // Scaled to match volume

            const now = Date.now();
            
            // IF volume spike > threshold AND cooldown has passed
            if (averageVolume > threshold && (now - lastTriggerTime > cooldown)) {
                triggerWord(maxFreqIndex);
                lastTriggerTime = now;
            }
        }

        // === WORD SELECTION ALGORITHM ===
        function triggerWord(freqSeed) {
            // THEORY: We use the dominant Frequency (freqSeed) to influence randomness.
            // If the spirit can manipulate the pitch of the sound, they can manipulate the index.
            
            // Mix normal math.random with the frequency seed
            const randomFactor = Math.random() * dictionary.length;
            const freqFactor = (freqSeed % dictionary.length); 
            
            // Combine them to get final index
            const finalIndex = Math.floor((randomFactor + freqFactor)) % dictionary.length;
            const selectedWord = dictionary[finalIndex];

            // Display Word
            output.innerText = selectedWord;
            
            // Log it
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement("div");
            entry.innerText = `[${timestamp}] SIGNAL: ${selectedWord} (Freq: ${freqSeed})`;
            historyDiv.prepend(entry);
            
            // Visual Flare (Flash screen)
            document.body.style.backgroundColor = "#003300";
            setTimeout(() => { document.body.style.backgroundColor = "#0d0d0d"; }, 100);
        }

    </script>
</body>
</html>
